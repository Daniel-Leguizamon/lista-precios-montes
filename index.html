<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Lista de Precios - Montes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="styles.css?v=6">
<link rel="icon" type="image/png" href="favicon.png?v=1">
</head>

<body>

<div class="container">

    <header class="header">
        <img src="LogoMontes.png" class="logo" alt="Logo Montes">
        <h1>Lista de Precios</h1>
    </header>

    <div class="filters">
        <input type="text" id="buscar" placeholder="Buscar producto...">
        <select id="filtroRubro">
            <option value="todos">Todos los rubros</option>
        </select>
    </div>

    <table>
        <thead>
            <tr>
                <th>Producto</th>
                <th>Rubro</th>
                <th class="th-precio">Precio</th>
                <th>Agregar</th>
            </tr>
        </thead>
        <tbody id="tabla">
        </tbody>
    </table>

    <!-- Sección de presupuesto / carrito -->
    <div id="presupuesto" class="presupuesto">
        <h2>
            Presupuesto
            <span id="presupuesto-resumen" class="presupuesto-resumen"></span>
        </h2>
        <div id="presupuesto-lista" class="presupuesto-lista">
            <p class="presupuesto-vacio">No hay productos en el presupuesto.</p>
        </div>
        <div class="presupuesto-footer">
            <span id="presupuesto-total" class="presupuesto-total">Total: $ 0</span>
            <div class="presupuesto-buttons">
                <button id="btn-vaciar" type="button" class="btn-secundario">Vaciar</button>
                <button id="btn-whatsapp" type="button" class="btn-principal">Enviar por WhatsApp</button>
            </div>
        </div>
    </div>

</div>

<!-- Botón flotante para ir al presupuesto / volver arriba -->
<button id="btn-ir-presupuesto" class="btn-flotante" type="button" title="Ir al presupuesto">↓</button>

<script>
    let datos = [];
    let carrito = [];
    const btnIrPresupuesto = document.getElementById("btn-ir-presupuesto");
    let modoIrArriba = false; // false = bajar al presupuesto, true = subir al buscador

    // ---------------------------
    // CARGAR CSV
    // ---------------------------
    async function cargarCSV() {
        const response = await fetch("./lista_precios.csv");
        const buffer = await response.arrayBuffer();
        const texto = new TextDecoder("utf-8").decode(buffer);

        let lineas = texto.split("\n").map(l => l.trim());

        for (let i = 1; i < lineas.length; i++) {
            if (!lineas[i]) continue;
            let cols = lineas[i].split(";");

            let descripcion = cols[0]?.trim() || "";
            let rubro = cols[1]?.trim() || "";
            let precioTexto = cols[2]?.trim() || "";

            if (rubro.toLowerCase().includes("no encontrado")) {
                rubro = "Cervezas";
            }

            let precioNumero = Number(
                precioTexto
                    .replace(/\./g, "")
                    .replace(",", ".")
                    .replace(/[^0-9.]/g, "")
            ) || 0;

            datos.push({
                id: i - 1,
                descripcion,
                rubro,
                precio: precioNumero
            });
        }

        cargarRubros();
        mostrarTabla(datos);
    }

    function cargarRubros() {
        let select = document.getElementById("filtroRubro");
        let rubros = [...new Set(datos.map(d => d.rubro))].sort();

        rubros.forEach(r => {
            let option = document.createElement("option");
            option.value = r;
            option.textContent = r;
            select.appendChild(option);
        });
    }

    // ---------------------------
    // TABLA
    // ---------------------------
    function mostrarTabla(lista) {
        let tabla = document.getElementById("tabla");
        tabla.innerHTML = "";

        lista.forEach(item => {
            let tr = document.createElement("tr");
            let precioFormateado = "$ " + item.precio.toLocaleString("es-AR");

            tr.innerHTML = `
                <td>${item.descripcion}</td>
                <td>${item.rubro}</td>
                <td class="col-precio">${precioFormateado}</td>
                <td>
                    <div class="qty-wrapper" data-id="${item.id}">
                        <span class="qty-label">Cant.</span>
                        <button type="button" class="qty-btn qty-minus" data-id="${item.id}">-</button>
                        <input type="number" min="1" value="1" class="qty-input" data-id="${item.id}">
                        <button type="button" class="qty-btn qty-plus" data-id="${item.id}">+</button>
                        <button type="button" class="btn-agregar" data-id="${item.id}">Agregar</button>
                    </div>
                </td>
            `;
            tabla.appendChild(tr);
        });
    }

    // ---------------------------
    // FILTROS
    // ---------------------------
    document.getElementById("buscar").addEventListener("input", filtrar);
    document.getElementById("filtroRubro").addEventListener("change", filtrar);

    function filtrar() {
        let texto = document.getElementById("buscar").value.toLowerCase();
        let rubro = document.getElementById("filtroRubro").value;

        let filtrados = datos.filter(item =>
            (rubro === "todos" || item.rubro === rubro) &&
            item.descripcion.toLowerCase().includes(texto)
        );

        mostrarTabla(filtrados);
    }

    // ---------------------------
    // CLICK EN TABLA (CANTIDAD + AGREGAR)
    // ---------------------------
    document.getElementById("tabla").addEventListener("click", function(e) {
        const target = e.target;

        // Botones + y -
        if (target.classList.contains("qty-btn")) {
            const wrapper = target.closest(".qty-wrapper");
            if (!wrapper) return;
            const input = wrapper.querySelector(".qty-input");
            if (!input) return;

            let valor = parseInt(input.value, 10) || 1;

            if (target.classList.contains("qty-plus")) {
                valor++;
            } else if (target.classList.contains("qty-minus")) {
                valor = Math.max(1, valor - 1);
            }

            input.value = valor;
            return;
        }

        // Botón Agregar
        if (target.classList.contains("btn-agregar")) {
            const wrapper = target.closest(".qty-wrapper");
            if (!wrapper) return;

            const input = wrapper.querySelector(".qty-input");
            let cantidad = parseInt(input.value, 10) || 1;
            const id = Number(wrapper.dataset.id);

            // MODO CELU: primer toque solo abre los controles
            if (window.innerWidth <= 700 && !wrapper.classList.contains("open")) {
                wrapper.classList.add("open");
                target.textContent = "OK";
                return;
            }

            agregarAlCarrito(id, cantidad);

            // feedback visual
            target.classList.add("btn-agregar-ok");
            setTimeout(() => target.classList.remove("btn-agregar-ok"), 200);

            // en celu, cerramos panel y volvemos el texto
            if (window.innerWidth <= 700) {
                wrapper.classList.remove("open");
                target.textContent = "Agregar";
            }
        }
    });

    // ---------------------------
    // CARRITO
    // ---------------------------
    function agregarAlCarrito(idProducto, cantidad) {
        const producto = datos.find(d => d.id === idProducto);
        if (!producto) return;

        let item = carrito.find(p => p.id === idProducto);
        if (item) {
            item.cantidad += cantidad;
        } else {
            carrito.push({
                id: producto.id,
                descripcion: producto.descripcion,
                precio: producto.precio,
                cantidad: cantidad
            });
        }

        mostrarCarrito();
    }

    function mostrarCarrito() {
        const cont = document.getElementById("presupuesto-lista");
        const totalSpan = document.getElementById("presupuesto-total");
        const resumenSpan = document.getElementById("presupuesto-resumen");

        if (carrito.length === 0) {
            cont.innerHTML = `<p class="presupuesto-vacio">No hay productos en el presupuesto.</p>`;
            totalSpan.textContent = "Total: $ 0";
            if (resumenSpan) resumenSpan.textContent = "";
            if (btnIrPresupuesto) btnIrPresupuesto.classList.remove("visible");
            return;
        }

        let total = 0;
        let totalCantidad = 0;
        let html = "<ul>";

        carrito.forEach(item => {
            const subtotal = item.precio * item.cantidad;
            total += subtotal;
            totalCantidad += item.cantidad;

            html += `
                <li>
                    <span class="pres-desc">${item.descripcion}</span>
                    <span class="pres-cant">
                        <input type="number" min="1" value="${item.cantidad}" class="input-cant" data-id="${item.id}">
                    </span>
                    <span class="pres-sub">$ ${subtotal.toLocaleString("es-AR")}</span>
                </li>
            `;
        });

        html += "</ul>";
        cont.innerHTML = html;
        totalSpan.textContent = "Total: $ " + total.toLocaleString("es-AR");

        if (resumenSpan) {
            const txt = totalCantidad === 1 ? "1 ítem" : totalCantidad + " ítems";
            resumenSpan.textContent = `(${txt})`;
        }

        // mostrar botón flotante
        if (btnIrPresupuesto) {
            btnIrPresupuesto.classList.add("visible");
        }
    }

    // Cambiar cantidades desde el presupuesto
    document.getElementById("presupuesto-lista").addEventListener("change", function(e) {
        if (e.target.classList.contains("input-cant")) {
            const id = Number(e.target.dataset.id);
            let nueva = Number(e.target.value);
            if (isNaN(nueva) || nueva < 1) {
                nueva = 1;
                e.target.value = 1;
            }

            let item = carrito.find(p => p.id === id);
            if (item) {
                item.cantidad = nueva;
                mostrarCarrito();
            }
        }
    });

    // ---------------------------
    // WHATSAPP
    // ---------------------------
    function generarTextoPresupuesto() {
        if (carrito.length === 0) {
            return "Hola! Quisiera consultar la disponibilidad de los siguientes productos para realizar una compra.\n\n(Sin productos seleccionados)";
        }

        let lineas = [];
        lineas.push("Hola! Quisiera consultar la disponibilidad de los siguientes productos para realizar una compra.");
        lineas.push("");

        let total = 0;
        carrito.forEach(item => {
            const subtotal = item.precio * item.cantidad;
            total += subtotal;
            lineas.push(`• ${item.descripcion} x${item.cantidad} - $ ${subtotal.toLocaleString("es-AR")}`);
        });

        lineas.push("");
        lineas.push("Total aproximado: $ " + total.toLocaleString("es-AR"));
        lineas.push("");
        lineas.push("Montes • Almacén de Bebidas");

        return lineas.join("\n");
    }

    document.getElementById("btn-vaciar").addEventListener("click", function() {
        carrito = [];
        mostrarCarrito();
    });

    document.getElementById("btn-whatsapp").addEventListener("click", function() {
        if (carrito.length === 0) {
            alert("No hay productos en el presupuesto.");
            return;
        }

        const texto = generarTextoPresupuesto();
        const url = "https://wa.me/5492212244033?text=" + encodeURIComponent(texto);
        window.open(url, "_blank");
    });

    // ---------------------------
    // BOTÓN FLOTANTE: SUBIR / BAJAR
    // ---------------------------
    if (btnIrPresupuesto) {
        btnIrPresupuesto.addEventListener("click", () => {
            if (modoIrArriba) {
                window.scrollTo({ top: 0, behavior: "smooth" });
            } else {
                const presupuestoDiv = document.getElementById("presupuesto");
                if (presupuestoDiv) {
                    presupuestoDiv.scrollIntoView({ behavior: "smooth" });
                }
            }
        });

        window.addEventListener("scroll", () => {
            if (!btnIrPresupuesto.classList.contains("visible")) return;

            if (window.scrollY < 150) {
                modoIrArriba = false;
                btnIrPresupuesto.textContent = "↓";
            } else {
                modoIrArriba = true;
                btnIrPresupuesto.textContent = "↑";
            }
        });
    }

    // Iniciar
    cargarCSV();
</script>

</body>
</html>






